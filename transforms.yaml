metadata:
    name: ScraperPipeline
    version: 1.0.0
source:
    - scraper
dependencies:
    - requests
    - beautifulsoup4
transforms:
    - ScrapeWebPages: scraper:ScrapeWebPages
source_code:
    scraper: aW1wb3J0IGFwYWNoZV9iZWFtIGFzIGJlYW0KaW1wb3J0IGxvZ2dpbmcKZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHVybHBhcnNlLCB1cmxqb2luCmltcG9ydCB0aW1lCmZyb20gYnM0IGltcG9ydCBCZWF1dGlmdWxTb3VwCmltcG9ydCByZXF1ZXN0cwoKbG9nZ2VyID0gbG9nZ2luZy5nZXRMb2dnZXIoX19maWxlX18pCmxvZ2dpbmcuYmFzaWNDb25maWcobGV2ZWw9bG9nZ2luZy5JTkZPKQoKY2xhc3MgU2NyYXBlV2ViUGFnZXMoYmVhbS5QVHJhbnNmb3JtKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtYXhfZGVwdGg6IGludCA9IDEsIG1pbl9jaGFyX3NpemU6IGludCA9IDMwKToKICAgICAgICBzZWxmLm1heF9kZXB0aCA9IG1heF9kZXB0aAogICAgICAgIHNlbGYubWluX2NoYXJfc2l6ZSA9IG1pbl9jaGFyX3NpemUKCiAgICBkZWYgZXhwYW5kKHNlbGYsIHBjb2xsKToKICAgICAgICByZXR1cm4gcGNvbGwgfCBiZWFtLlBhckRvKHNlbGYuU2NyYXBlV2ViUGFnZShzZWxmLm1heF9kZXB0aCwgc2VsZi5taW5fY2hhcl9zaXplKSkKCiAgICBjbGFzcyBTY3JhcGVXZWJQYWdlKGJlYW0uRG9Gbik6CiAgICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIG1heF9kZXB0aCwgbWluX2NoYXJfc2l6ZSk6CiAgICAgICAgICAgIHNlbGYubWF4X2RlcHRoID0gbWF4X2RlcHRoCiAgICAgICAgICAgIHNlbGYudmlzaXRlZF91cmxzID0ge30KICAgICAgICAgICAgc2VsZi5taW5fY2hhcl9zaXplID0gbWluX2NoYXJfc2l6ZQoKICAgICAgICBkZWYgcHJvY2VzcyhzZWxmLCBlbGVtZW50KToKICAgICAgICAgICAgdXJsID0gZWxlbWVudC5lbGVtZW50CiAgICAgICAgICAgIGJhc2VfZG9tYWluID0gdXJscGFyc2UodXJsKS5uZXRsb2MKICAgICAgICAgICAgeWllbGQgZnJvbSBzZWxmLnNjcmFwZV9wYWdlKHVybCwgYmFzZV9kb21haW4sIDApCgogICAgICAgIGRlZiBzY3JhcGVfcGFnZShzZWxmLCB1cmwsIGJhc2VfZG9tYWluLCBkZXB0aCk6CiAgICAgICAgICAgIGlmIGRlcHRoID4gc2VsZi5tYXhfZGVwdGggb3IgdXJsIGluIHNlbGYudmlzaXRlZF91cmxzOgogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNjcmFwaW5nIFVSTDoge3VybH0gYXQgZGVwdGgge2RlcHRofSIpCiAgICAgICAgICAgIHNlbGYudmlzaXRlZF91cmxzW3VybF0gPSBUcnVlCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldCh1cmwpCiAgICAgICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICAgICAgICAgICAgICBzb3VwID0gQmVhdXRpZnVsU291cChyZXNwb25zZS50ZXh0LCAnaHRtbC5wYXJzZXInKQoKICAgICAgICAgICAgICAgIGZvciBzY3JpcHRfb3Jfc3R5bGUgaW4gc291cChbJ3NjcmlwdCcsICdzdHlsZSddKToKICAgICAgICAgICAgICAgICAgICBzY3JpcHRfb3Jfc3R5bGUuZGVjb21wb3NlKCkKCiAgICAgICAgICAgICAgICB0aXRsZSA9IHNvdXAudGl0bGUuc3RyaW5nIGlmIHNvdXAudGl0bGUgZWxzZSAiTm8gVGl0bGUiCgogICAgICAgICAgICAgICAgZm9yIGxldmVsIGluIHJhbmdlKDIsIDcpOgogICAgICAgICAgICAgICAgICAgIGZvciBoZWFkaW5nIGluIHNvdXAuZmluZF9hbGwoZidoe2xldmVsfScpOgogICAgICAgICAgICAgICAgICAgICAgICBoZWFkaW5nX3RleHQgPSBoZWFkaW5nLmdldF90ZXh0KCkKCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnQgPSBbXQogICAgICAgICAgICAgICAgICAgICAgICBmb3Igc2libGluZyBpbiBoZWFkaW5nLm5leHRfc2libGluZ3M6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzaWJsaW5nLm5hbWUgYW5kIHNpYmxpbmcubmFtZS5zdGFydHN3aXRoKCdoJyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaWJsaW5nX2xldmVsID0gaW50KHNpYmxpbmcubmFtZVsxXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2libGluZ19sZXZlbCA8PSBsZXZlbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHNpYmxpbmcsIHN0cik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VnbWVudC5hcHBlbmQoc2libGluZy5zdHJpcCgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50LmFwcGVuZChzaWJsaW5nLmdldF90ZXh0KHN0cmlwPVRydWUpKQogICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50X3RleHQgPSAiICIuam9pbihzZWdtZW50KS5zdHJpcCgpCgogICAgICAgICAgICAgICAgICAgICAgICAjIFlpZWxkIGVhY2ggaGVhZGluZyBhbmQgaXRzIGNvcnJlc3BvbmRpbmcgdGV4dCBhcyBhIHNlcGFyYXRlIGRpY3Rpb25hcnkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHNlZ21lbnRfdGV4dCkgPiBzZWxmLm1pbl9jaGFyX3NpemU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpdGxlIjogc3RyKHRpdGxlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaGVhZGluZyI6IHN0cihoZWFkaW5nX3RleHQpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0ZXh0Ijogc3RyKHNlZ21lbnRfdGV4dCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInVybCI6IHN0cih1cmwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIGxpbmsgaW4gc291cC5maW5kX2FsbCgnYScsIGhyZWY9VHJ1ZSk6CiAgICAgICAgICAgICAgICAgICAgYWJzb2x1dGVfbGluayA9IHVybGpvaW4odXJsLCBsaW5rWydocmVmJ10pCiAgICAgICAgICAgICAgICAgICAgbGlua19kb21haW4gPSB1cmxwYXJzZShhYnNvbHV0ZV9saW5rKS5uZXRsb2MKCiAgICAgICAgICAgICAgICAgICAgaWYgbGlua19kb21haW4gPT0gYmFzZV9kb21haW46CiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIGZyb20gc2VsZi5zY3JhcGVfcGFnZShhYnNvbHV0ZV9saW5rLCBiYXNlX2RvbWFpbiwgZGVwdGggKyAxKQoKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoLjUpCiAgICAgICAgICAgIGV4Y2VwdCByZXF1ZXN0cy5leGNlcHRpb25zLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIHNjcmFwaW5nIHt1cmx9OiB7ZX0iKQ==
encoding: base64
